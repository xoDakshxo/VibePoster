# VibePoster - Data Models

## Database: SQLite via Prisma

## Entity Relationship Diagram

```
┌────────────┐       ┌──────────────┐       ┌────────────┐
│   Trend    │──1:1──│  StyleCard   │       │            │
│            │       │              │       │            │
│            │──1:N──│ ScrapedPost  │       │            │
│            │       │              │       │            │
│            │──1:N──│    Post      │───────│  PostLog   │
└────────────┘       └──────────────┘       └────────────┘
```

## Prisma Schema

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// A topic/niche the user wants to post about
model Trend {
  id          String   @id @default(cuid())
  name        String                          // e.g., "AI Agents"
  keywords    String                          // comma-separated: "AI agents, autonomous AI, agentic"
  description String?                         // optional context about the trend
  status      String   @default("new")        // new | scraped | styled | active
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  styleCard    StyleCard?
  scrapedPosts ScrapedPost[]
  posts        Post[]
}

// Style profile extracted from viral posts for a specific trend
model StyleCard {
  id        String   @id @default(cuid())
  trendId   String   @unique
  trend     Trend    @relation(fields: [trendId], references: [id], onDelete: Cascade)

  tone      String                            // e.g., "confident, slightly provocative"
  format    String                            // e.g., "hot take opener + evidence + question"
  minWords  Int      @default(40)
  maxWords  Int      @default(80)
  hooks     String                            // JSON array of hook patterns
  avoid     String                            // JSON array of things to avoid
  examples  String                            // JSON array of example posts
  locked    Boolean  @default(false)          // true = approved by user

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// A post scraped from Bluesky for style analysis
model ScrapedPost {
  id        String   @id @default(cuid())
  trendId   String
  trend     Trend    @relation(fields: [trendId], references: [id], onDelete: Cascade)

  uri       String                            // Bluesky post URI (at://)
  authorDid String                            // author's DID
  authorHandle String                         // author's handle
  content   String                            // post text
  likes     Int      @default(0)
  reposts   Int      @default(0)
  replies   Int      @default(0)
  engagement Int     @default(0)              // computed: likes + reposts*2 + replies
  postedAt  DateTime                          // when the original post was made
  scrapedAt DateTime @default(now())

  @@index([trendId, engagement])
}

// A post generated by VibePoster for publishing
model Post {
  id        String   @id @default(cuid())
  trendId   String
  trend     Trend    @relation(fields: [trendId], references: [id], onDelete: Cascade)

  content   String                            // the generated post text
  status    String   @default("draft")        // draft | approved | published | rejected
  tweetId   String?                           // X tweet ID after publishing
  tweetUrl  String?                           // URL to the published tweet

  createdAt   DateTime @default(now())
  publishedAt DateTime?
}
```

## Model Details

### Trend

The central entity. Represents a topic the user wants to post about.

| Field | Type | Description |
|-------|------|-------------|
| `id` | String (CUID) | Primary key |
| `name` | String | Human-readable topic name |
| `keywords` | String | Comma-separated search terms for scraping |
| `description` | String? | Optional context to help the LLM understand the niche |
| `status` | String | Lifecycle state of the trend |

**Status Lifecycle**:
```
new → scraped → styled → active
 │                         │
 └─── (delete) ◄──────────┘
```

- `new`: Just created, no scraping done yet
- `scraped`: Posts have been scraped, style not yet analyzed
- `styled`: Style Card generated and locked
- `active`: Has a locked Style Card and at least one generated post

### StyleCard

The extracted style profile for a trend. One-to-one with Trend.

| Field | Type | Description |
|-------|------|-------------|
| `tone` | String | Voice description (e.g., "witty, contrarian") |
| `format` | String | Structural pattern (e.g., "hook + point + CTA") |
| `minWords` / `maxWords` | Int | Target post length range |
| `hooks` | String (JSON) | Array of opening patterns that work |
| `avoid` | String (JSON) | Array of anti-patterns to steer clear of |
| `examples` | String (JSON) | 3 sample posts demonstrating the style |
| `locked` | Boolean | Whether user has approved this style |

**Note**: `hooks`, `avoid`, and `examples` are stored as JSON strings since SQLite doesn't support JSON columns natively. Parsed at the application layer.

### ScrapedPost

A post pulled from Bluesky's firehose during a scrape.

| Field | Type | Description |
|-------|------|-------------|
| `uri` | String | Bluesky AT Protocol URI (e.g., `at://did:plc:.../app.bsky.feed.post/...`) |
| `authorDid` | String | Author's decentralized identifier |
| `authorHandle` | String | Author's readable handle (e.g., `user.bsky.social`) |
| `content` | String | Full post text |
| `likes` / `reposts` / `replies` | Int | Engagement metrics |
| `engagement` | Int | Computed score: `likes + reposts*2 + replies` |
| `postedAt` | DateTime | Original post timestamp |

**Engagement scoring**: Reposts are weighted 2x because they indicate higher signal (someone actively chose to amplify). This can be tuned later.

### Post

A VibePoster-generated post for publishing to X.

| Field | Type | Description |
|-------|------|-------------|
| `content` | String | Generated post text (max 280 chars for X) |
| `status` | String | Lifecycle state |
| `tweetId` | String? | X's tweet ID after successful publish |
| `tweetUrl` | String? | Direct URL to the published tweet |

**Status Lifecycle**:
```
draft → approved → published
  │        │
  └────────┴──→ rejected
```

## Indexes

- `ScrapedPost(trendId, engagement)`: Fast lookup of top posts per trend
- `Trend.status`: Filter trends by lifecycle state
- `Post.status`: Filter posts by draft/approved/published

## Data Retention

For the POC:
- Scraped posts are kept indefinitely (small volume)
- Old scraped posts can be purged manually
- Published posts are kept for reference
- No automatic cleanup in v0.1
